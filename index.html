<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Exercise Counter</title>
  <style>
    body { font-family: system-ui, sans-serif; padding:16px; background:#f9fafb; color:#111; }
    .card { background:#fff; border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:12px; }
    h1 { font-size:1.1rem; margin:0 0 8px 0; }
    label { display:block; margin-top:8px; font-size:.9rem; }
    input, select, button { font-size:1rem; padding:10px; margin-top:6px; width:100%; border-radius:8px; border:1px solid #e2e8f0; box-sizing:border-box; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .big { font-size:1.6rem; font-weight:700; text-align:center; padding:12px 0; }
    .status { font-size:.9rem; text-align:center; margin-top:8px; color:#444; }
    .controls { display:flex; gap:8px; margin-top:8px; }
    .controls button { flex:1; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Exercise Counter (Phone Sensors)</h1>
    <div class="status">Hold phone in hand. Select exercise â†’ Calibrate â†’ Start.</div>
  </div>

  <div class="card">
    <label>Weight (kg)</label>
    <input type="number" id="weight" value="70" min="20" />

    <label>Exercise</label>
    <select id="exercise">
      <option value="5" data-axis="beta">Squats â€” MET 5</option>
      <option value="8" data-axis="beta">Push-ups â€” MET 8</option>
      <option value="8" data-axis="beta">Jumping Jacks â€” MET 8</option>
      <option value="3" data-axis="alpha">Walking (in place) â€” MET 3</option>
      <option value="4" data-axis="beta">Yoga / Stretch â€” MET 4</option>
      <option value="6" data-axis="beta">Arm Curls â€” MET 6</option>
    </select>
  </div>

  <div class="card">
    <div class="row">
      <button id="requestPerm">Request Motion Permission</button>
      <button id="calibrate">Calibrate Rest Angle</button>
    </div>

    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div class="big" id="countDisplay">Reps: 0</div>
    <div class="status" id="liveAngles">alpha: â€” | beta: â€” | gamma: â€”</div>
    <div class="status" id="timeAndCalories">Time: 00:00 | Calories: 0.00 kcal</div>
    <div class="status" id="scoreOutput"></div>
  </div>

<script>
let restAngle = null;
let angleAxis = 'beta';
let weightKg = 70;
let MET = 6;
let reps = 0;
let state = 'down';
let listening = false;
let startTime = null;
let elapsedMs = 0;
let filteredAngle = null;
let timerInterval = null;
let smoothing = 0.15;

const countDisplay = document.getElementById('countDisplay');
const liveAngles = document.getElementById('liveAngles');
const timeAndCalories = document.getElementById('timeAndCalories');
const scoreOutput = document.getElementById('scoreOutput');

function updateExerciseSettings() {
  let sel = document.getElementById('exercise');
  MET = Number(sel.value);
  angleAxis = sel.options[sel.selectedIndex].dataset.axis;
  weightKg = Number(document.getElementById('weight').value) || 70;
}

// Request sensor permissions (iOS needs it)
async function requestMotionPermission(){
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try { await DeviceMotionEvent.requestPermission(); } catch {}
  }
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try { await DeviceOrientationEvent.requestPermission(); } catch {}
  }
  alert('Motion permission handled. Now calibrate.');
}
document.getElementById('requestPerm').addEventListener('click', requestMotionPermission);

document.getElementById('calibrate').addEventListener('click', () => {
  if (filteredAngle === null) return alert("Move phone gently first");
  restAngle = filteredAngle;
  alert("Calibrated rest angle: " + restAngle.toFixed(1) + "Â° on " + angleAxis);
});

document.getElementById('startBtn').addEventListener('click', () => {
  updateExerciseSettings();
  if (restAngle === null && filteredAngle !== null) restAngle = filteredAngle;
  reps = 0;
  state = 'down';
  listening = true;
  startTime = Date.now();
  scoreOutput.textContent = "";
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  countDisplay.textContent = 'Reps: 0';
  timerInterval = setInterval(updateTimeAndCalories, 500);
});

document.getElementById('stopBtn').addEventListener('click', () => {
  listening = false;
  clearInterval(timerInterval);
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
  givePerformanceScore();
});

// Low-pass smoothing
function smoothAngle(inAngle){
  if (filteredAngle === null) filteredAngle = inAngle;
  filteredAngle = filteredAngle + smoothing * (inAngle - filteredAngle);
  return filteredAngle;
}

function handleOrientation(e){
  let a = e.alpha ?? 0, b = e.beta ?? 0, g = e.gamma ?? 0;
  liveAngles.textContent = `alpha: ${a.toFixed(1)} | beta: ${b.toFixed(1)} | gamma: ${g.toFixed(1)}`;

  let raw = angleAxis === 'alpha' ? a : (angleAxis === 'beta' ? b : g);
  let s = smoothAngle(raw);

  if (!listening) return;

  let upThreshold = restAngle + 15;
  let downThreshold = restAngle + 5;

  if (state === 'down' && s > upThreshold) state = 'up';
  else if (state === 'up' && s < downThreshold) {
    state = 'down';
    reps++;
    countDisplay.textContent = 'Reps: ' + reps;
  }
}

function updateTimeAndCalories(){
  elapsedMs = Date.now() - startTime;
  const elapsedHours = elapsedMs / 3600000.0;
  const calories = MET * weightKg * elapsedHours;
  const mins = Math.floor(elapsedMs / 60000);
  const secs = Math.floor((elapsedMs % 60000)/1000);
  timeAndCalories.textContent = `Time: ${mins}:${secs.toString().padStart(2,'0')} | Calories: ${calories.toFixed(2)} kcal`;
}

function givePerformanceScore(){
  let score = "Good Job!";
  if (reps < 5) score = "Needs Improvement ðŸš¶";
  else if (reps < 15) score = "Nice Work ðŸ’ª";
  else score = "Excellent ðŸ”¥";
  scoreOutput.textContent = `Score: ${score} | Reps: ${reps}`;
}

if (window.DeviceOrientationEvent) {
  window.addEventListener('deviceorientation', handleOrientation, true);
}
</script>
</body>
</html>
