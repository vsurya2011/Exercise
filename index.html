<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Phone Sensor Exercise Counter (All Sensors)</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, Arial; padding:16px; background:#f7f8fb; color:#111; }
    .card { background:#fff; border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:12px; }
    h1 { font-size:1.1rem; margin:0 0 8px 0; }
    label { font-size:.9rem; display:block; margin-top:8px; color:#444; }
    input, select, button { font-size:1rem; padding:10px; margin-top:6px; width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #e2e8f0; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .big { font-size:1.6rem; font-weight:700; text-align:center; padding:12px 0; }
    .small { font-size:.85rem; color:#666; }
    .status { text-align:center; margin-top:8px; }
    .controls { display:flex; gap:8px; margin-top:8px; }
    .controls button { flex:1; }
    footer { margin-top:12px; font-size:.8rem; color:#666; text-align:center; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Exercise Rep Counter (All Sensors)</h1>
    <div class="small">Uses device orientation (alpha, beta, gamma) at the same time. Hold phone in hand, calibrate, then start.</div>
  </div>

  <div class="card" id="settings">
    <label>Weight (kg)</label>
    <input type="number" id="weight" value="70" min="20" />

    <label>Exercise / MET</label>
    <select id="exercise">
      <option value="5">Squats — MET 5</option>
      <option value="8">Push-ups — MET 8</option>
      <option value="8">Jumping Jacks — MET 8</option>
      <option value="3">Walking (in place) — MET 3</option>
      <option value="4">Yoga / Stretch — MET 4</option>
      <option value="6">Arm Curls — MET 6</option>
    </select>

    <label>Up Threshold (degrees, all axes)</label>
    <input type="number" id="upThreshold" value="18" min="3" />

    <label>Down Threshold (degrees, all axes)</label>
    <input type="number" id="downThreshold" value="6" min="1" />
  </div>

  <div class="card">
    <div class="row">
      <button id="requestPerm">Request Motion Permission</button>
      <button id="calibrate">Calibrate Rest Angles</button>
    </div>

    <div class="row controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div class="big" id="countDisplay">Reps: 0</div>
    <div class="small status" id="liveAngles">alpha: — | beta: — | gamma: —</div>
    <div class="small status" id="timeAndCalories">Time: 00:00 | Calories: 0.00 kcal</div>
  </div>

  <div class="card small">
    <div><strong>How it works</strong></div>
    <ul>
      <li>Calibrate to set rest angles while holding the phone naturally.</li>
      <li>All three axes (alpha, beta, gamma) are tracked simultaneously.</li>
      <li>When any axis crosses above <em>rest + upThreshold</em> and back below <em>rest + downThreshold</em>, it counts as 1 rep.</li>
    </ul>
  </div>

  <footer>Tip: Hold phone firmly. Best results when one axis clearly moves during your exercise.</footer>

<script>
/*
  Exercise rep counter using all DeviceOrientation axes (alpha, beta, gamma).
  - Each axis has its own state machine (down→up→down counts a rep).
  - Calories: MET * weight (kg) * duration_hours
*/

let restAngles = { alpha: null, beta: null, gamma: null };
let thresholds = { up: 18, down: 6 };
let filtered = { alpha:null, beta:null, gamma:null };
let states = { alpha:'down', beta:'down', gamma:'down' };
let smoothing = 0.15;

let weightKg = 70;
let MET = 6;
let reps = 0;
let listening = false;
let startTime = null;
let elapsedMs = 0;
let timerInterval = null;

const countDisplay = document.getElementById('countDisplay');
const liveAngles = document.getElementById('liveAngles');
const timeAndCalories = document.getElementById('timeAndCalories');

function updateSettingsFromUI(){
  thresholds.up = Number(document.getElementById('upThreshold').value);
  thresholds.down = Number(document.getElementById('downThreshold').value);
  weightKg = Number(document.getElementById('weight').value) || 70;
  MET = Number(document.getElementById('exercise').value) || 6;
}

['upThreshold','downThreshold','weight','exercise'].forEach(id=>{
  document.getElementById(id).addEventListener('change', updateSettingsFromUI);
});

async function requestMotionPermission(){
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try { await DeviceMotionEvent.requestPermission(); } catch(e){ console.warn(e); }
  }
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try { await DeviceOrientationEvent.requestPermission(); } catch(e){ console.warn(e); }
  }
  alert('Sensor permission granted (or not needed). Now calibrate and start.');
}
document.getElementById('requestPerm').addEventListener('click', requestMotionPermission);

// Calibrate: sample all angles
document.getElementById('calibrate').addEventListener('click', () => {
  if (filtered.alpha===null || filtered.beta===null || filtered.gamma===null) {
    alert('Move phone gently and press Calibrate while holding rest position.');
    return;
  }
  restAngles.alpha = filtered.alpha;
  restAngles.beta  = filtered.beta;
  restAngles.gamma = filtered.gamma;
  alert(`Calibrated rest: α=${restAngles.alpha.toFixed(1)} β=${restAngles.beta.toFixed(1)} γ=${restAngles.gamma.toFixed(1)}`);
});

// Start & Stop
document.getElementById('startBtn').addEventListener('click', () => {
  updateSettingsFromUI();
  if (restAngles.alpha===null || restAngles.beta===null || restAngles.gamma===null) {
    alert('Please calibrate first.');
    return;
  }
  reps = 0;
  states = { alpha:'down', beta:'down', gamma:'down' };
  listening = true;
  startTime = Date.now();
  elapsedMs = 0;
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  countDisplay.textContent = 'Reps: 0';
  timerInterval = setInterval(updateTimeAndCalories, 500);
});
document.getElementById('stopBtn').addEventListener('click', () => {
  listening = false;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
  clearInterval(timerInterval);
  updateTimeAndCalories();
});

// Helpers
function normalizeAngle(a){
  if (a > 180) return a - 360;
  if (a < -180) return a + 360;
  return a;
}
function smoothAxis(axis,val){
  if (filtered[axis]===null) filtered[axis]=val;
  let f=filtered[axis];
  if (axis==='alpha'){
    let diff=val-f;
    if (diff>180) diff-=360;
    if (diff<-180) diff+=360;
    filtered[axis]=f+smoothing*diff;
    if (filtered[axis]>180) filtered[axis]-=360;
    if (filtered[axis]<-180) filtered[axis]+=360;
  } else {
    filtered[axis]=f+smoothing*(val-f);
  }
  return filtered[axis];
}

function handleOrientation(e){
  let a = e.alpha!==null? normalizeAngle(e.alpha):null;
  let b = e.beta!==null? normalizeAngle(e.beta):null;
  let g = e.gamma!==null? normalizeAngle(e.gamma):null;

  if (a!==null) a=smoothAxis('alpha',a);
  if (b!==null) b=smoothAxis('beta',b);
  if (g!==null) g=smoothAxis('gamma',g);

  liveAngles.textContent = `α:${a?.toFixed(1)} | β:${b?.toFixed(1)} | γ:${g?.toFixed(1)}`;

  if (!listening) return;

  ['alpha','beta','gamma'].forEach(axis=>{
    if (restAngles[axis]===null || filtered[axis]===null) return;
    let upTrig = restAngles[axis] + thresholds.up;
    let downTrig = restAngles[axis] + thresholds.down;
    let s = filtered[axis];
    if (states[axis]==='down' && s>upTrig){
      states[axis]='up';
    } else if (states[axis]==='up' && s<downTrig){
      states[axis]='down';
      reps++;
      countDisplay.textContent = 'Reps: ' + reps;
    }
  });
}

function updateTimeAndCalories(){
  if (!startTime) return;
  elapsedMs = Date.now() - startTime;
  const elapsedMin = elapsedMs / 60000.0;
  const elapsedHours = elapsedMs / 3600000.0;
  const calories = MET * weightKg * elapsedHours;
  const mins = Math.floor(elapsedMin);
  const secs = Math.floor((elapsedMin - mins) * 60);
  timeAndCalories.textContent = `Time: ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')} | Calories: ${calories.toFixed(2)} kcal`;
}

// Attach listeners
if (window.DeviceOrientationEvent) {
  window.addEventListener('deviceorientation', handleOrientation, true);
} else {
  alert('DeviceOrientation not supported on this device/browser.');
}
</script>
</body>
</html>
